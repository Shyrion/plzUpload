/*! PlzUpload 2014-04-07 */
MenuController=function(){this.menuButton=$("#menuButton"),this.menuDiv=$("#menu"),this.menuUploadsDiv=$("#menuUploads"),this.menuUploadsSpeech=$(".speech",this.menuUploadsDiv),this.opened=!1,$("#menuButton").click(function(){this.opened?this.close():this.open()}.bind(this)),$("#getUploadButton").click(function(){var a=location.protocol+"//"+location.hostname+":"+location.port+"/"+$("#getUploadField").val(),b=window.open(a,"_blank");b.focus()}),$("#getUploadField").keydown(function(){window.setTimeout(function(){$("#getUploadButton").css("display",""!=$(this).val()?"block":"none")}.bind(this),1)}),this.facebookLoginDiv=$("#facebookLogin"),this.facebookLogoutDiv=$("#facebookLogout"),this.facebookLogoutDiv.hide(),this.allUploads={}},MenuController.prototype.bindUploadOnClick=function(a,b){a.click(function(){var a=location.protocol+"//"+location.hostname+":"+location.port+"/"+b,c=window.open(a,"_blank");return c.focus(),!1})},MenuController.prototype.isOpened=function(){return this.opened},MenuController.prototype.open=function(){$("#menu").show(),$("#mainContent").animate({right:"187",queue:!1}),$("#menu").animate({right:"0",queue:!1}),this.opened=!0},MenuController.prototype.close=function(){$("#mainContent").animate({right:"0",queue:!1}),$("#menu").animate({right:"-202",queue:!1},400,function(){console.log("Finished"),$("#menu").hide()}),this.opened=!1},MenuController.prototype.addUpload=function(a){this.menuUploadsSpeech.hide();var b=$('<div class="upload"><div class="uploadHeader"><span class="uploadName">'+a.name+'</span></div><div class="uploadProgress"><progress data-id="0" value="0" max="100"></progress><span class="progressValue">0%</span></div></div>');return this.menuUploadsDiv.append(b),b},MenuController.prototype.onUploadFinished=function(a,b,c){$(".uploadProgress",a).remove();var d=$('<div class="uploadCode">Code: <a href="'+c+'">'+b+"</a></div>");this.bindUploadOnClick($("a",d),b),a.append(d)},MenuController.prototype.onUploadFailed=function(a){a.remove(),$(".upload",this.menuUploadsDiv).length||this.menuUploadsSpeech.show()},MenuController.prototype.addFacebookLogin=function(a){},MenuController.prototype.onFBLogin=function(a){this.facebookLoginDiv.hide(),this.facebookLogoutDiv.show();var b=this;$.ajax("/uploads/"+a.id,{type:"GET",complete:function(a){var c=JSON.parse(a.responseText);"ok"==c.result?c.allUploads.length&&c.allUploads.forEach(function(a){var c=b.addUpload(a);b.onUploadFinished(c,a.code+"."+a.ext,location.origin+"/"+a.code+"."+a.ext)}):console.log("Error",c)}.bind(this)})},MenuController.prototype.onFBLogout=function(){this.facebookLoginDiv.show(),this.facebookLogoutDiv.hide()};;var UploadProgress=function(a){this.progressDiv=a,this.progressBar=$("progress",this.progressDiv),this.progressValue=$(".progressValue",this.progressDiv)};UploadProgress.prototype.setProgress=function(a){this.progressBar.attr("value",a),this.progressValue.html(a+"%")};;var DragDropController=function(a,b){this.menuController=b,this.nbRunningUploads=0,this.allUploads={},this.multiUploadAuthorized=!1;new DropZone(a,function(a){if(!this.multiUploadAuthorized&&this.nbRunningUploads)return void console.log("One at a time !");var c=new XMLHttpRequest;c.open("POST",location.href+"uploadAjax");var d={name:a.name,type:a.type};if(this.allUploads[a.name])return void console.log("File already uploading...");this.allUploads[name]=d;var e=this.menuController.addUpload(d),f=new UploadProgress($(".progress",e)[0]);c.onload=function(){console.log("load",d)},c.onerror=function(){console.log("error"),b.onUploadFailed(e)},c.upload.onprogress=function(a){progression=Math.round(a.loaded/a.total*100*100/100),f.setProgress(progression)},c.upload.onloadstart=function(){console.log("load start"),this.menuController.isOpened()||this.menuController.open()}.bind(this);var g=this;c.onreadystatechange=function(){if(4==c.readyState&&200==c.status){var a=JSON.parse(this.responseText);if(console.log(a),"ok"==a.result){var d=(a.uploadUrl,a.fullUrl),f=a.uploadCode;b.onUploadFinished(e,f,d)}else{{var h=a.error;h.message}b.onUploadFailed(e)}g.nbRunningUploads--,g.nbRunningUploads||$("body").trigger("noUploadRunning")}};var h=new FormData;h.append("uploadedFile",a),c.send(h),this.nbRunningUploads++}.bind(this))};DragDropController.prototype.authorizeMultiUpload=function(){this.multiUploadAuthorized=!0},DragDropController.prototype.unauthorizeMultiUpload=function(){this.multiUploadAuthorized=!1};;function checkUserStatus(){fbManager.checkUserStatus(function(a){"connected"==a&&fbManager.login(function(a){console.log("Autologin success ? ",a),menuController&&menuController.onFBLogin(fbManager.currentUser),fbManager.getUserInfo(function(a){fbManager.currentUser.name=a.name})},"email")})}var menuController=new MenuController,dragDrop=new DragDropController("centeredZone",menuController);$("body").on("authorizeMultiupload",function(){console.log("Authorize multi"),dragDrop.authorizeMultiUpload}.bind(this)),$("body").on("unauthorizeMultiupload",function(){console.log("Unauthorize multi"),dragDrop.unauthorizeMultiUpload=!1}.bind(this)),new CPGame("settings.json",function(a){var b=function(){console.log("Resources loaded !"),CPSceneManager.instance.setScene("MainScene")}.bind(this),c=function(){};CPResourceManager.instance.init(a.allImages,b,c),CPResourceManager.instance.startLoading()});var timer=null;$(window).resize(function(){function a(){CPGame.instance.canvasWidth=$(window).width(),CPGame.instance.canvasHeight=$(window).height(),$("canvas").attr("width",CPGame.instance.canvasWidth),$("canvas").attr("height",CPGame.instance.canvasHeight),$("body").trigger("resizeEnd")}window.clearTimeout(timer),timer=window.setTimeout(a,500)}),$("#centeredZone").on("dragover",function(a){fileDropOK&&$("body").trigger("fileDragOver",a)}),$("#centeredZone").on("dragenter",function(a){fileDropOK?$("body").trigger("fileDragEnter",a):$("body").trigger("oneAtATime")}),$("#centeredZone").on("dragleave",function(){fileDropOK&&$("body").trigger("fileDragOut")}),$("#centeredZone").on("dragend",function(){$("body").trigger("fileDragFinished")}),$("#centeredZone").on("dragout",function(){$("body").trigger("fileDragOut")});var fileDropOK=!0;$("#centeredZone").on("drop",function(){fileDropOK&&($("body").trigger("fileDropped"),fileDropOK=!1)}),$("body").on("noUploadRunning",function(){fileDropOK=!0});var fbManager=new FacebookManager;fbManager.setServerValidationUrl(location.origin+"/ws/facebookLogin"),$("#FBLogin").click(function(){fbManager.login(function(a){a?fbManager.getUserInfo(function(a){fbManager.currentUser.name=a.name,menuController&&menuController.onFBLogin(fbManager.currentUser),$("body").trigger("authorizeMultiupload")}):console.log("User resigned :(")},"email")}),$("#FBLogout").click(function(){fbManager.logout(function(a){a?(menuController&&menuController.onFBLogout(),$("body").trigger("unauthorizeMultiupload")):console.log("Failed to logout ? :(")})}),fbManager.init({appId:"601752169899573",locale:"en_GB"},checkUserStatus);;var MainScene=function(a){function b(){j(),r.playRepeat("breathing",7,function(){r.playOnce("blink",function(){Math.floor(4*Math.random())?c():d()})})}function c(){r.playRepeat("crying",26,function(){r.playOnce("blink",function(){Math.floor(4*Math.random())?b():c()})})}function d(){r.playRepeat("jump",2,function(){b()})}function e(){r.playRepeat("disapointed",4,function(){r.playOnce("disapointedBlink",function(){Math.floor(2*Math.random())?e():b()})})}function f(){r.start("eating")}function g(){r.playOnce("glups",function(){r.playRepeat("happy",12,function(){b()})})}function h(){r.pause(),r.playRepeat("nono",2,function(){console.log("eat"),f()})}function i(){return u}function j(){u=!1,s.y=t.y=-2500}function k(a){var b=a.x,c=a.y,d=Math.abs(w-b),e=Math.abs(x-b),f=Math.abs(v-c),g=Math.atan(f/d),h=Math.atan(f/e),i=rightEyeRayDeltaX=leftEyeRayDeltaY=rightEyeRayDeltaY=y,j=d*d+f*f;y*y>j&&(i=d,leftEyeRayDeltaY=f);var k=e*e+f*f;y*y>k&&(rightEyeRayDeltaX=e,rightEyeRayDeltaY=f);var l=Math.cos(g)*i,m=Math.sin(g)*leftEyeRayDeltaY,n=Math.cos(h)*rightEyeRayDeltaX,o=Math.sin(h)*rightEyeRayDeltaY;l*=w>b?1:-1,m*=v>c?1:-1,n*=x>b?1:-1,o*=v>c?1:-1,s.x=w-l,s.y=v-m,t.x=x-n,t.y=v-m,s.needsRedraw(),t.needsRedraw()}this.parent.call(this,a),this.backgroundLayer=this.addLayer(10),this.characterLayer=this.addLayer(15);var l=CPGame.instance.canvasWidth,m=CPGame.instance.canvasHeight,n=new CPDisplayGroup,o=new CPText({x:0,y:0,content:"PlzUpload",anchor:Anchors.TOPCENTER,font:"70pt BeautifulEveryTime",color:"rgb(0, 0, 0)"},this);n.insert("titleText",o),this.backgroundLayer.insert("titleText",o);var p=new CPText({x:o.width/2,y:o.height,content:"I'm hungry",anchor:Anchors.CENTERRIGHT,font:"24pt BeautifulEveryTime",color:"rgb(0, 0, 0)"},this);n.insert("subtitleText",p),this.backgroundLayer.insert("subtitleText",p),n.x=l/2,n.y=50;var q=new CPDisplayGroup,r=new CPSprite({x:0,y:0,width:40,height:100,anchor:Anchors.CENTER});q.insert("animatedSprite",r),this.characterLayer.insert("animatedSprite",r),r.add({sequenceName:"breathing",spriteSheet:CPResourceManager.instance.getImage("animBreathing"),totalFrame:6,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animBreathing").width/6,h:CPResourceManager.instance.getImage("animBreathing").height}}),r.add({sequenceName:"blink",spriteSheet:CPResourceManager.instance.getImage("animBlink"),totalFrame:6,offset:0,framePerSecond:6,frameSize:{w:CPResourceManager.instance.getImage("animBlink").width/6,h:CPResourceManager.instance.getImage("animBlink").height}}),r.add({sequenceName:"jump",spriteSheet:CPResourceManager.instance.getImage("animJump"),totalFrame:4,offset:0,framePerSecond:10,frameSize:{w:CPResourceManager.instance.getImage("animJump").width/4,h:CPResourceManager.instance.getImage("animJump").height}}),r.add({sequenceName:"crying",spriteSheet:CPResourceManager.instance.getImage("animCrying"),totalFrame:5,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animCrying").width/6,h:CPResourceManager.instance.getImage("animCrying").height}}),r.add({sequenceName:"openMouth",spriteSheet:CPResourceManager.instance.getImage("animOpenMouth"),totalFrame:4,offset:0,framePerSecond:12,frameSize:{w:CPResourceManager.instance.getImage("animOpenMouth").width/4,h:CPResourceManager.instance.getImage("animOpenMouth").height}}),r.add({sequenceName:"hystery",spriteSheet:CPResourceManager.instance.getImage("animHystery"),totalFrame:6,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animHystery").width/6,h:CPResourceManager.instance.getImage("animHystery").height}}),r.add({sequenceName:"eating",spriteSheet:CPResourceManager.instance.getImage("animEating"),totalFrame:6,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animEating").width/6,h:CPResourceManager.instance.getImage("animEating").height}}),r.add({sequenceName:"glups",spriteSheet:CPResourceManager.instance.getImage("animGlups"),totalFrame:6,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animGlups").width/6,h:CPResourceManager.instance.getImage("animGlups").height}}),r.add({sequenceName:"disapointed",spriteSheet:CPResourceManager.instance.getImage("animDisapointed"),totalFrame:6,offset:0,framePerSecond:6,frameSize:{w:CPResourceManager.instance.getImage("animDisapointed").width/6,h:CPResourceManager.instance.getImage("animDisapointed").height}}),r.add({sequenceName:"disapointedBlink",spriteSheet:CPResourceManager.instance.getImage("animDisapointedBlink"),totalFrame:6,offset:0,framePerSecond:6,frameSize:{w:CPResourceManager.instance.getImage("animDisapointedBlink").width/6,h:CPResourceManager.instance.getImage("animDisapointedBlink").height}}),r.add({sequenceName:"happy",spriteSheet:CPResourceManager.instance.getImage("animHappy"),totalFrame:4,offset:0,framePerSecond:8,frameSize:{w:CPResourceManager.instance.getImage("animHappy").width/4,h:CPResourceManager.instance.getImage("animHappy").height}}),r.add({sequenceName:"nono",spriteSheet:CPResourceManager.instance.getImage("animNo"),totalFrame:4,offset:0,framePerSecond:10,frameSize:{w:CPResourceManager.instance.getImage("animNo").width/4,h:CPResourceManager.instance.getImage("animNo").height}});var s=new CPImage({x:0,y:-2500,img:CPResourceManager.instance.getImage("eye"),width:48,height:39,scale:1,anchor:Anchors.CENTER});q.insert("leftEye",s),this.characterLayer.insert("leftEye",s);var t=new CPImage({x:0,y:s.y,img:CPResourceManager.instance.getImage("eye"),width:48,height:39,scale:1,anchor:Anchors.CENTER});q.insert("rightEye",t),this.characterLayer.insert("rightEye",t),q.x=l/2,q.y=m/2,l=m=null;var u=!1;$("body").on("fileDragEnter",function(a,b){j(),r.playOnce("openMouth",function(){u=!0,r.start("hystery"),$("body").trigger("fileDragOver",b)})}.bind(this)),$("body").on("oneAtATime",function(){h()}.bind(this));var v=r.y-25,w=r.x-64,x=r.x+73,y=12;$("body").on("fileDragOver",function(a,b){i()&&k({x:b.originalEvent.clientX+parseInt($("#mainContent").css("right")),y:b.originalEvent.clientY})}.bind(this)),$("body").on("fileDragFinished",function(){j(),b()}.bind(this)),$("body").on("fileDropped",function(){j(),f()}.bind(this)),$("body").on("fileDragOut",function(){j(),e()}.bind(this)),$("body").on("noUploadRunning",function(){j(),g()}.bind(this)),$("body").on("resizeEnd",function(){n.x=CPGame.instance.canvasWidth/2,o.draw(),p.draw(),r.x=CPGame.instance.canvasWidth/2,r.y=Math.max(n.y+p.y+p.height+r.height/2*r.scale,CPGame.instance.canvasHeight/2),console.log(n.y,p.y,p.height,CPGame.instance.canvasHeight/2,r.y)}),b()};MainScene.inheritsFrom(CPScene),MainScene.prototype.free=function(){console.log("free")};